<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kindle Reader</title>
<style>
  /* RESET B√ÅSICO E ALTO CONTRASTE */
  body {
    background-color: #ffffff;
    color: #000000;
    font-family: 'Georgia', 'Times New Roman', serif; /* Serifado √© melhor para e-ink */
    font-size: 18px; /* Fonte base maior */
    line-height: 1.5;
    margin: 0;
    padding: 10px;
  }

  h1, h2, h3 { margin: 10px 0; color: #000; font-weight: bold; }
  hr { border: 0; border-top: 2px solid #000; margin: 20px 0; }
  a { text-decoration: none; color: #000; }

  /* BOT√ïES GRANDES E CLAROS (Bordas pretas puras) */
  button, .btn {
    background: #fff;
    color: #000;
    border: 3px solid #000;
    padding: 12px 5px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    display: block;
    margin-bottom: 15px;
    box-sizing: border-box;
    text-align: center;
    font-family: sans-serif; /* Bot√µes em sans-serif para contraste com texto */
  }
  
  button:active { background: #000; color: #fff; } /* Feedback visual simples */
  button:disabled { border-color: #999; color: #999; }

  /* CAMPOS DE BUSCA */
  input[type="text"] {
    width: 100%;
    padding: 12px;
    font-size: 18px;
    border: 2px solid #000;
    margin-bottom: 10px;
    box-sizing: border-box;
  }

  /* LISTAS */
  .list-item {
    border-bottom: 1px solid #000;
    padding: 15px 0;
    display: block;
  }
  .source-tag { font-size: 0.8em; text-transform: uppercase; font-weight: bold; }

  /* LEITOR - Removendo imagens para performance */
  #reader-content img { display: none !important; } /* Imagens travam o Kindle */
  #reader-content p { margin-bottom: 1em; text-align: justify; }

  /* UTILIT√ÅRIOS */
  .hidden { display: none; }
  .error { border: 2px solid black; padding: 10px; font-weight: bold; }
  #loading { font-weight: bold; font-size: 20px; text-align: center; padding: 20px; display: none; }

</style>
</head>
<body>

  <div id="nav-top">
    <button onclick="app.goHome()">üè† IN√çCIO / HIST√ìRICO</button>
    <div id="search-box">
      <input type="text" id="search-input" placeholder="Digite o nome da novel...">
      <button onclick="app.search()">BUSCAR</button>
    </div>
  </div>

  <div id="loading">CARREGANDO...</div>

  <hr>

  <main id="main-content">
    
    <div id="view-list">
      <h2 id="list-title">Hist√≥rico</h2>
      <div id="list-container"></div>
    </div>

    <div id="view-details" class="hidden">
      <h2 id="novel-title"></h2>
      <p id="novel-desc" style="font-size: 0.9em; font-style: italic;"></p>
      <h3>Cap√≠tulos:</h3>
      <div id="chapter-list"></div>
    </div>

    <div id="view-reader" class="hidden">
      <button onclick="app.goBackToDetails()">‚â° VOLTAR PARA LISTA</button>
      <div style="display:flex; gap:5px;">
        <button id="btn-prev-top">ANTERIOR</button>
        <button id="btn-next-top">PR√ìXIMO</button>
      </div>
      
      <h2 id="read-title" style="text-align:center; margin-top:20px;"></h2>
      <hr>
      <div id="reader-content"></div>
      <hr>
      
      <div style="display:flex; gap:5px; margin-top:20px;">
        <button id="btn-prev-btm">ANTERIOR</button>
        <button id="btn-next-btm">PR√ìXIMO</button>
      </div>
      <br><br><br> </div>

  </main>

  <script>
    // ================= SERVI√áO (MANTIDO IGUAL, APENAS L√ìGICA) =================
    class NovelApiService {
      constructor() { this.proxy = "https://relaxed-churros-9a35ea.netlify.app/?destination="; }
      async _fetch(url, opt={}) {
        try {
          const res = await fetch(this.proxy + url, { method: opt.method||"GET", headers: opt.headers||{}, body: opt.body||null });
          const text = await res.text();
          return new DOMParser().parseFromString(text, "text/html");
        } catch(e) { throw e; }
      }
      _safeText(el) { return el ? el.textContent.trim() : ""; }
      _safeAttr(el, a) { return el ? el.getAttribute(a) : ""; }
      _safeHTML(el) { return el ? el.innerHTML : ""; }

      // Scrapers simplificados para performance (apenas o essencial)
      async searchAll(text) {
        const p = [this._centralSearch(text), this._illusiaSearch(text), this._maniaSearch(text)];
        const r = await Promise.allSettled(p);
        return r.map(i => i.status === 'fulfilled' ? i.value : []).flat();
      }
      async getNovelInfo(id) {
        const [src, ...rest] = id.split("-"); const slug = rest.join("-");
        if(src==='central') return this._centralInfo(slug);
        if(src==='illusia') return this._illusiaInfo(slug);
        if(src==='mania') return this._maniaInfo(slug);
      }
      async getChapter(nid, cid) {
        const [src, ...rest] = nid.split("-"); const slug = rest.join("-");
        if(src==='central') return this._centralChap(cid);
        if(src==='illusia') return this._illusiaChap(slug, cid);
        if(src==='mania') return this._maniaChap(slug, cid);
      }

      // --- CENTRAL NOVEL ---
      async _centralSearch(q) {
        const body = new URLSearchParams({ action: "ts_ac_do_search", ts_ac_query: q });
        const res = await fetch(this.proxy + "https://centralnovel.com/wp-admin/admin-ajax.php", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body });
        const json = await res.json();
        if (!json?.series?.[0]) return [];
        return json.series[0].all.map(a => ({ nome: a.post_title, id: `central-${a.post_link.split("/").filter(Boolean).pop()}`, source: 'CEN' }));
      }
      async _centralInfo(slug) {
        const doc = await this._fetch(`https://centralnovel.com/series/${slug}/`);
        const chaps = [...doc.querySelectorAll(".eplister a")].filter((_,i)=>i%2===0).reverse().map(a => [this._safeText(a.querySelector(".epl-num")), a.getAttribute("href").split("/").filter(Boolean).pop()]);
        return { nome: this._safeText(doc.querySelector("h1")), desc: this._safeText(doc.querySelector(".entry-content")), chapters: chaps };
      }
      async _centralChap(slug) {
        const doc = await this._fetch(`https://centralnovel.com/${slug}/`);
        return { title: this._safeText(doc.querySelector("h1")), content: this._safeHTML(doc.querySelector(".epcontent")) };
      }

      // --- ILLUSIA ---
      async _illusiaSearch(q) {
        const doc = await this._fetch(`https://illusia.com.br/?s=${encodeURIComponent(q)}&post_type=fcn_story`, { method:"POST" });
        return [...doc.querySelectorAll("li.card a")].map(a => ({ nome: a.textContent.trim(), id: `illusia-${a.getAttribute("href").split("/").filter(Boolean).pop()}`, source: 'ILL' }));
      }
      async _illusiaInfo(slug) {
        const doc = await this._fetch(`https://illusia.com.br/story/${slug}/`);
        const chaps = [...doc.querySelectorAll(".chapter-group__list a")].map(a => [a.textContent.trim(), a.getAttribute("href").split("/").filter(Boolean).pop()]);
        return { nome: this._safeText(doc.querySelector(".story__identity-title")), desc: "", chapters: chaps };
      }
      async _illusiaChap(slug, chap) {
        const doc = await this._fetch(`https://illusia.com.br/story/${slug}/${chap}/`);
        return { title: this._safeText(doc.querySelector(".chapter__title")), content: this._safeHTML(doc.querySelector("#chapter-content")) };
      }

      // --- NOVEL MANIA ---
      async _maniaSearch(q) {
        const doc = await this._fetch(`https://novelmania.com.br/novels?titulo=${encodeURIComponent(q)}`);
        return [...doc.querySelectorAll(".top-novels h5")].map(h => {
           const a = h.closest('a') || h.parentElement.querySelector('a');
           return { nome: h.textContent.trim(), id: `mania-${a.getAttribute("href").split("/").filter(Boolean).pop()}`, source: 'MAN' };
        });
      }
      async _maniaInfo(slug) {
        const doc = await this._fetch(`https://novelmania.com.br/novels/${slug}/`);
        const chaps = [...doc.querySelectorAll("ol.list-inline li a")].map(a => [a.querySelector("strong").textContent, a.getAttribute("href").split("/").filter(Boolean).pop()]);
        return { nome: this._safeText(doc.querySelector("h1")), desc: "", chapters: chaps };
      }
      async _maniaChap(slug, chap) {
        const doc = await this._fetch(`https://novelmania.com.br/novels/${slug}/capitulos/${chap}`);
        return { title: this._safeText(doc.querySelector("h2")), content: this._safeHTML(doc.querySelector("#chapter-content")) };
      }
    }

    // ================= APP L√ìGICA =================
    class App {
      constructor() {
        this.api = new NovelApiService();
        this.history = JSON.parse(localStorage.getItem('kindle_hist') || '[]');
        this.currentNovel = null;
        this.renderHistory();
      }

      // Utilit√°rios de UI
      loading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
      hideAll() { ['view-list', 'view-details', 'view-reader'].forEach(id => document.getElementById(id).classList.add('hidden')); window.scrollTo(0,0); }
      
      goHome() {
        this.hideAll();
        document.getElementById('view-list').classList.remove('hidden');
        document.getElementById('list-title').innerText = "Hist√≥rico de Leitura";
        document.getElementById('search-input').value = "";
        this.renderHistory();
      }

      renderHistory() {
        const c = document.getElementById('list-container');
        if(!this.history.length) { c.innerHTML = "<p>Nenhum hist√≥rico.</p>"; return; }
        c.innerHTML = this.history.map(h => `
          <div class="list-item">
            <div class="source-tag">[${h.source}]</div>
            <div style="font-weight:bold; font-size:1.1em">${h.name}</div>
            <div style="color:#555">√öltimo: ${h.chapName || '---'}</div>
            <button style="margin-top:10px" onclick="app.read('${h.nid}', '${h.cid}')">CONTINUAR LENDO</button>
            <button style="margin-top:5px; border:1px solid #ccc" onclick="app.loadNovel('${h.nid}')">VER CAP√çTULOS</button>
          </div>
        `).join('');
      }

      async search() {
        const q = document.getElementById('search-input').value;
        if(!q) return;
        this.hideAll();
        document.getElementById('view-list').classList.remove('hidden');
        document.getElementById('list-title').innerText = "Resultados: " + q;
        document.getElementById('list-container').innerHTML = "";
        this.loading(true);
        try {
          const list = await this.api.searchAll(q);
          document.getElementById('list-container').innerHTML = list.map(n => `
            <div class="list-item">
               <span class="source-tag">[${n.source}]</span> <b>${n.nome}</b>
               <button style="margin-top:10px" onclick="app.loadNovel('${n.id}')">ABRIR</button>
            </div>
          `).join('');
          if(!list.length) document.getElementById('list-container').innerHTML = "<p>Nada encontrado.</p>";
        } catch(e) { document.getElementById('list-container').innerHTML = `<p class="error">Erro: ${e.message}</p>`; }
        this.loading(false);
      }

      async loadNovel(id) {
        this.hideAll();
        this.loading(true);
        try {
          const info = await this.api.getNovelInfo(id);
          this.currentNovel = { ...info, id };
          
          document.getElementById('novel-title').innerText = info.nome;
          document.getElementById('novel-desc').innerText = info.desc.substring(0, 300) + "...";
          
          // Renderiza cap√≠tulos como bot√µes grandes para toque f√°cil
          document.getElementById('chapter-list').innerHTML = info.chapters.map(c => `
            <button style="text-align:left; font-size:16px; font-weight:normal" onclick="app.read('${id}', '${c[1]}')">
              ${c[0]}
            </button>
          `).join('');

          document.getElementById('view-details').classList.remove('hidden');
        } catch(e) { alert("Erro ao carregar novel"); this.goHome(); }
        this.loading(false);
      }

      async read(nid, cid) {
        this.hideAll();
        this.loading(true);
        document.getElementById('read-title').innerText = "";
        document.getElementById('reader-content').innerHTML = "";

        try {
          const data = await this.api.getChapter(nid, cid);
          document.getElementById('view-reader').classList.remove('hidden');
          
          // Update Content
          document.getElementById('read-title').innerText = data.title;
          document.getElementById('reader-content').innerHTML = data.content;

          // Encontra Prev/Next baseados na lista carregada anteriormente ou l√≥gica simples
          // NOTA: Para simplificar no Kindle, precisamos ter carregado a novel antes ou confiar no hist√≥rico
          // Aqui tentaremos achar na currentNovel. Se n√£o tiver, desabilita bot√µes temporariamente
          let prev = null, next = null;
          
          if(this.currentNovel && this.currentNovel.id === nid) {
             const idx = this.currentNovel.chapters.findIndex(c => c[1] == cid);
             if(idx > 0) next = this.currentNovel.chapters[idx-1][1]; // Arrays geralmente s√£o [novo...velho] ou [velho...novo]. Assumindo ordena√ß√£o padr√£o de scrapers (desc)
             if(idx < this.currentNovel.chapters.length-1) prev = this.currentNovel.chapters[idx+1][1];
             
             // Invers√£o comum em scrapers: se index 0 √© o ultimo cap lan√ßado, 'next' na leitura √© index+1 se a lista for crescente.
             // Vamos simplificar: A maioria das listas vem Recente -> Antigo.
             // Ent√£o Next Chapter (hist√≥ria avan√ßa) √© index-1. Prev Chapter √© index+1.
          }

          const setupBtn = (bid1, bid2, target) => {
             const el1 = document.getElementById(bid1);
             const el2 = document.getElementById(bid2);
             if(target) {
               el1.disabled = false; el1.onclick = () => app.read(nid, target);
               el2.disabled = false; el2.onclick = () => app.read(nid, target);
             } else {
               el1.disabled = true; el2.disabled = true;
             }
          };
          
          setupBtn('btn-prev-top', 'btn-prev-btm', prev);
          setupBtn('btn-next-top', 'btn-next-btm', next);

          // Salvar hist√≥rico
          this.saveHistory(nid, this.currentNovel ? this.currentNovel.nome : "Novel", cid, data.title);

        } catch(e) { 
           document.getElementById('view-reader').innerHTML = `<p class="error">Erro ao carregar texto: ${e}</p>`;
           document.getElementById('view-reader').classList.remove('hidden');
        }
        this.loading(false);
      }

      saveHistory(nid, name, cid, cname) {
        let h = this.history.filter(x => x.nid !== nid);
        h.unshift({ nid, name, cid, chapName: cname, source: nid.split('-')[0] });
        if(h.length > 10) h.pop();
        this.history = h;
        localStorage.setItem('kindle_hist', JSON.stringify(h));
      }

      goBackToDetails() {
        if(this.currentNovel) {
           document.getElementById('view-reader').classList.add('hidden');
           document.getElementById('view-details').classList.remove('hidden');
        } else {
           this.goHome();
        }
      }
    }

    window.app = new App();
  </script>
</body>
</html>
