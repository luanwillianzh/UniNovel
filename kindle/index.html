<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindle Reader (Legacy)</title>
    <style>
        /* CSS BÁSICO E SEGURO */
        body { background: white; color: black; font-family: Georgia, serif; font-size: 120%; margin: 0; padding: 5px; }
        
        /* Layout em Bloco (Evita Flexbox que trava Kindle antigo) */
        .container { max-width: 100%; margin: 0 auto; }
        
        button {
            display: block; width: 100%; padding: 15px 0; margin-bottom: 10px;
            background: white; border: 3px solid black; color: black;
            font-size: 18px; font-weight: bold; cursor: pointer; text-transform: uppercase;
        }
        button:hover { background: black; color: white; }

        input[type="text"] {
            width: 95%; padding: 10px; font-size: 18px;
            border: 2px solid black; margin-bottom: 10px;
        }

        .novel-item { border-bottom: 1px solid black; padding: 10px 0; }
        .novel-title { font-weight: bold; font-size: 1.1em; }
        .source { font-size: 0.8em; background: #eee; padding: 2px; }

        .hidden { display: none; }
        #loader { padding: 20px; text-align: center; font-weight: bold; border: 2px dashed black; display: none; }
        
        /* Leitura */
        #reader-text { text-align: justify; line-height: 1.5; }
        #reader-text p { margin-bottom: 1em; }
        #reader-text img { display: none; } /* Remove imagens para não travar */
        
        /* Navegação do Leitor */
        .nav-btns { margin-top: 20px; text-align: center; }
        .nav-btns button { width: 48%; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <div id="menu">
        <button onclick="App.goHome()">INÍCIO / HISTÓRICO</button>
        <input type="text" id="search-input" placeholder="Nome da Novel...">
        <button onclick="App.search()">BUSCAR</button>
    </div>

    <div id="loader">CARREGANDO... AGUARDE</div>

    <div id="view-list" class="view">
        <h2 id="list-header">Histórico</h2>
        <div id="list-content"></div>
    </div>

    <div id="view-details" class="view hidden">
        <h2 id="det-title"></h2>
        <div id="det-chapters"></div>
    </div>

    <div id="view-reader" class="view hidden">
        <button onclick="App.backToDetails()">VOLTAR PARA CAPÍTULOS</button>
        <h3 id="chap-title" style="text-align:center"></h3>
        <hr>
        <div id="reader-text"></div>
        <div class="nav-btns">
            <button id="btn-prev" onclick="App.prevChap()">ANTERIOR</button>
            <button id="btn-next" onclick="App.nextChap()">PRÓXIMO</button>
        </div>
        <div style="height: 50px;"></div>
    </div>
</div>

<script>
    // =========================================================
    // UTILITÁRIOS (Compatível com IE8/Kindle Antigo)
    // =========================================================
    var PROXY = "https://relaxed-churros-9a35ea.netlify.app/?destination=";

    // Substituto do fetch (AJAX Clássico)
    function httpRequest(url, method, data, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open(method, PROXY + url, true);
        if (method === "POST") {
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        }
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    callback(null, xhr.responseText);
                } else {
                    callback("Erro: " + xhr.status);
                }
            }
        };
        xhr.onerror = function() { callback("Erro de Conexão"); };
        xhr.send(data);
    }

    function parseHTML(html) {
        var div = document.createElement('div');
        div.innerHTML = html;
        return div;
    }

    // =========================================================
    // LÓGICA DA APLICAÇÃO
    // =========================================================
    var App = {
        history: [],
        currentNovel: null,
        currentChapId: null,

        init: function() {
            try {
                var h = localStorage.getItem('kindle_hist_v2');
                if (h) this.history = JSON.parse(h);
            } catch(e) {}
            this.renderHistory();
        },

        toggleLoader: function(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        },

        showView: function(id) {
            var views = ['view-list', 'view-details', 'view-reader'];
            for (var i = 0; i < views.length; i++) {
                document.getElementById(views[i]).style.display = 'none';
            }
            document.getElementById(id).style.display = 'block';
            window.scrollTo(0, 0);
        },

        // --- NAVEGAÇÃO ---
        goHome: function() {
            this.showView('view-list');
            this.renderHistory();
            document.getElementById('list-header').innerHTML = "Histórico";
            document.getElementById('search-input').value = "";
        },

        // --- BUSCA ---
        search: function() {
            var q = document.getElementById('search-input').value;
            if (!q) return;

            this.showView('view-list');
            document.getElementById('list-header').innerHTML = "Buscando: " + q;
            document.getElementById('list-content').innerHTML = "";
            this.toggleLoader(true);

            // Busca simplificada: Apenas CentralNovel para evitar timeout do Kindle
            // Kindle não aguenta muitas requisições paralelas
            var that = this;
            var body = "action=ts_ac_do_search&ts_ac_query=" + encodeURIComponent(q);
            
            httpRequest("https://centralnovel.com/wp-admin/admin-ajax.php", "POST", body, function(err, text) {
                that.toggleLoader(false);
                if (err) {
                    alert(err);
                    return;
                }
                
                try {
                    var json = JSON.parse(text);
                    if (!json.series || !json.series[0]) {
                        document.getElementById('list-content').innerHTML = "Nada encontrado.";
                        return;
                    }
                    
                    var html = "";
                    var list = json.series[0].all;
                    for (var i = 0; i < list.length; i++) {
                        var item = list[i];
                        var linkParts = item.post_link.split('/');
                        var slug = linkParts[linkParts.length - 2] || linkParts[linkParts.length - 1];
                        var id = 'central-' + slug;
                        
                        html += '<div class="novel-item">';
                        html += '<div class="novel-title">' + item.post_title + '</div>';
                        html += '<button style="margin-top:5px" onclick="App.loadNovel(\'' + id + '\')">ABRIR</button>';
                        html += '</div>';
                    }
                    document.getElementById('list-content').innerHTML = html;
                } catch (e) {
                    document.getElementById('list-content').innerHTML = "Erro ao processar dados.";
                }
            });
        },

        // --- CARREGAR NOVEL ---
        loadNovel: function(id) {
            this.showView('view-details');
            document.getElementById('det-title').innerHTML = "Carregando...";
            document.getElementById('det-chapters').innerHTML = "";
            this.toggleLoader(true);

            var slug = id.replace('central-', '');
            var that = this;

            httpRequest("https://centralnovel.com/series/" + slug + "/", "GET", null, function(err, text) {
                that.toggleLoader(false);
                if (err) { alert("Erro ao carregar novel"); that.goHome(); return; }

                var doc = parseHTML(text);
                var title = doc.querySelector("h1").textContent;
                var links = doc.querySelectorAll(".eplister a");
                var chapters = [];

                // Filter logic for central novel (only even links usually)
                for (var i = 0; i < links.length; i++) {
                    // Logica simplificada: pegar todos os links que parecem caps
                    var t = links[i].querySelector(".epl-num");
                    if (t) {
                        var href = links[i].getAttribute("href");
                        var parts = href.split('/');
                        var cSlug = parts[parts.length - 2] || parts[parts.length - 1];
                        chapters.push({ title: t.textContent, id: cSlug });
                    }
                }
                
                // Salvar estado atual
                that.currentNovel = { id: id, title: title, chapters: chapters };
                
                // Renderizar
                document.getElementById('det-title').innerHTML = title;
                var html = '';
                // Inverter para ficar do cap 1 ao atual, se necessário, ou manter recente
                // Geralmente sites mostram recente primeiro.
                for (var j = 0; j < chapters.length; j++) {
                    var c = chapters[j];
                    html += '<button style="text-align:left; font-weight:normal" onclick="App.read(\'' + c.id + '\')">' + c.title + '</button>';
                }
                document.getElementById('det-chapters').innerHTML = html;
            });
        },

        // --- LER CAPÍTULO ---
        read: function(chapId) {
            this.currentChapId = chapId;
            this.showView('view-reader');
            document.getElementById('reader-text').innerHTML = "";
            document.getElementById('chap-title').innerHTML = "Carregando...";
            this.toggleLoader(true);

            var that = this;
            httpRequest("https://centralnovel.com/" + chapId + "/", "GET", null, function(err, text) {
                that.toggleLoader(false);
                if (err) { document.getElementById('reader-text').innerHTML = "Erro ao carregar texto."; return; }

                var doc = parseHTML(text);
                var content = doc.querySelector(".epcontent");
                var title = doc.querySelector("h1").textContent;

                // Limpeza de scripts e estilos do conteudo
                var scripts = content.getElementsByTagName('script');
                while(scripts.length > 0){ scripts[0].parentNode.removeChild(scripts[0]); }

                document.getElementById('chap-title').innerHTML = title;
                document.getElementById('reader-text').innerHTML = content.innerHTML;

                // Atualiza histórico
                that.addToHistory(that.currentNovel.title, title, that.currentNovel.id, chapId);
                window.scrollTo(0,0);
            });
        },

        // --- CONTROLES DE LEITURA ---
        nextChap: function() {
            if (!this.currentNovel) return;
            var idx = -1;
            for(var i=0; i<this.currentNovel.chapters.length; i++) {
                if(this.currentNovel.chapters[i].id === this.currentChapId) {
                    idx = i; break;
                }
            }
            // CentralNovel lista do mais novo para o mais velho (descrescente)
            // Então "Próximo" (história avança) é o indice anterior no array (idx - 1)
            // Se a lista estiver invertida, mude a logica.
            if (idx > 0) {
                this.read(this.currentNovel.chapters[idx - 1].id);
            } else {
                alert("Sem mais capítulos recentes na lista carregada.");
            }
        },

        prevChap: function() {
            if (!this.currentNovel) return;
            var idx = -1;
            for(var i=0; i<this.currentNovel.chapters.length; i++) {
                if(this.currentNovel.chapters[i].id === this.currentChapId) {
                    idx = i; break;
                }
            }
            if (idx < this.currentNovel.chapters.length - 1) {
                this.read(this.currentNovel.chapters[idx + 1].id);
            } else {
                alert("Este é o último capítulo disponível.");
            }
        },

        backToDetails: function() {
            this.showView('view-details');
        },

        // --- HISTÓRICO ---
        addToHistory: function(novelName, chapName, novelId, chapId) {
            // Remove duplicata
            var newHist = [];
            for(var i=0; i<this.history.length; i++) {
                if(this.history[i].id !== novelId) newHist.push(this.history[i]);
            }
            newHist.unshift({
                name: novelName,
                lastChap: chapName,
                id: novelId,
                chapId: chapId
            });
            // Limita a 10 itens
            if(newHist.length > 10) newHist.pop();
            
            this.history = newHist;
            localStorage.setItem('kindle_hist_v2', JSON.stringify(this.history));
        },

        renderHistory: function() {
            var el = document.getElementById('list-content');
            if (this.history.length === 0) {
                el.innerHTML = "<p>Nenhum histórico recente.</p>";
                return;
            }
            var html = "";
            for (var i = 0; i < this.history.length; i++) {
                var h = this.history[i];
                html += '<div class="novel-item">';
                html += '<div class="novel-title">' + h.name + '</div>';
                html += '<div class="source">Lido: ' + h.lastChap + '</div>';
                html += '<button style="margin-top:5px" onclick="App.loadNovel(\'' + h.id + '\')">CAPÍTULOS</button>';
                html += '<button style="margin-top:5px; border:1px solid #ccc" onclick="App.read(\'' + h.chapId + '\')">CONTINUAR</button>';
                html += '</div>';
            }
            el.innerHTML = html;
        }
    };

    // Inicializa
    window.onload = function() {
        App.init();
    };

</script>
</body>
</html>
