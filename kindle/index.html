<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniNovel Kindle</title>
    <style>
        /* CSS OTIMIZADO PARA E-INK / KINDLE */
        body { background: white; color: black; font-family: Georgia, serif; font-size: 100%; margin: 0; padding: 5px; }
        
        /* Elementos de UI grandes e s√≥lidos */
        button {
            display: block; width: 100%; padding: 12px 0; margin-bottom: 8px;
            background: white; border: 2px solid black; color: black;
            font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase;
        }
        button:hover { background: black; color: white; }
        
        input[type="text"] {
            width: 95%; padding: 10px; font-size: 16px;
            border: 2px solid black; margin-bottom: 10px;
        }

        /* Tags de fonte */
        .badge { font-size: 10px; padding: 2px 4px; color: white; font-weight: bold; vertical-align: middle; margin-right: 5px; }
        .bg-central { background: #b71c1c; }
        .bg-illusia { background: #0d47a1; }
        .bg-mania { background: #1b5e20; }

        .list-item { border-bottom: 1px solid #ccc; padding: 10px 0; }
        .list-title { font-weight: bold; font-size: 1.1em; }
        
        /* Utilit√°rios */
        .hidden { display: none; }
        #loader { padding: 15px; text-align: center; border: 2px dashed black; margin: 10px 0; display: none; }
        
        /* Leitor */
        #reader-content { text-align: justify; line-height: 1.6; font-size: 1.1em; }
        #reader-content p { margin-bottom: 1em; }
        #reader-content img { display: none !important; } /* Remove imagens para performance */
        
        .nav-btns { margin-top: 20px; text-align: center; }
        .nav-btns button { width: 48%; display: inline-block; }
    </style>
</head>
<body>

<div id="menu">
    <button onclick="App.goHome()">üè† IN√çCIO</button>
    <input type="text" id="search-input" placeholder="Digite o nome da obra...">
    <button onclick="App.search()">üîç BUSCAR EM TODOS</button>
</div>

<div id="loader">CARREGANDO...</div>
<div id="status-msg" style="text-align:center; font-size: 0.8em; margin-bottom: 5px;"></div>

<div id="view-list" class="view">
    <h2 id="list-header">Hist√≥rico</h2>
    <div id="list-content"></div>
</div>

<div id="view-details" class="view hidden">
    <h2 id="det-title"></h2>
    <div id="det-desc" style="font-style: italic; font-size: 0.9em; margin-bottom: 10px;"></div>
    <div id="det-chapters"></div>
</div>

<div id="view-reader" class="view hidden">
    <button onclick="App.backToDetails()">‚â° LISTA DE CAP√çTULOS</button>
    <h3 id="chap-title" style="text-align:center; margin: 10px 0;"></h3>
    <hr>
    <div id="reader-content"></div>
    <div class="nav-btns">
        <button id="btn-prev" onclick="App.prevChap()">ANTERIOR</button>
        <button id="btn-next" onclick="App.nextChap()">PR√ìXIMO</button>
    </div>
    <div style="height: 60px;"></div>
</div>

<script>
    // =========================================================
    // 1. UTILIT√ÅRIOS HTTP (AJAX CL√ÅSSICO - ES5)
    // =========================================================
    var PROXY = "https://relaxed-churros-9a35ea.netlify.app/?destination=";

    function httpRequest(url, method, data, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open(method, PROXY + url, true);
        if (method === "POST") xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) callback(null, xhr.responseText);
                else callback("Erro HTTP: " + xhr.status);
            }
        };
        xhr.onerror = function() { callback("Falha na conex√£o"); };
        try { xhr.send(data); } catch(e) { callback(e.message); }
    }

    function parseHTML(html) {
        var div = document.createElement('div');
        div.innerHTML = html;
        return div;
    }

    function cleanText(txt) {
        return txt ? txt.replace(/\s+/g, ' ').trim() : "";
    }

    // =========================================================
    // 2. SCRAPERS (L√ìGICA DE EXTRA√á√ÉO)
    // =========================================================
    var Scraper = {
        // --- CENTRAL NOVEL ---
        central: {
            search: function(q, cb) {
                var body = "action=ts_ac_do_search&ts_ac_query=" + encodeURIComponent(q);
                httpRequest("https://centralnovel.com/wp-admin/admin-ajax.php", "POST", body, function(err, res) {
                    if(err) return cb([]);
                    try {
                        var json = JSON.parse(res);
                        if(!json.series || !json.series[0]) return cb([]);
                        var list = json.series[0].all.map(function(item) {
                            var slug = item.post_link.split('/').filter(Boolean).pop();
                            return { 
                                source: 'central', 
                                id: 'central-' + slug, 
                                title: item.post_title 
                            };
                        });
                        cb(list);
                    } catch(e) { cb([]); }
                });
            },
            info: function(slug, cb) {
                httpRequest("https://centralnovel.com/series/" + slug + "/", "GET", null, function(err, html) {
                    if(err) return cb(null);
                    var doc = parseHTML(html);
                    var title = cleanText(doc.querySelector("h1").textContent);
                    // L√≥gica espec√≠fica: Titulo + Subtitulo
                    var links = doc.querySelectorAll(".eplister li a");
                    var chaps = [];
                    for(var i=0; i<links.length; i++) {
                        var a = links[i];
                        var num = a.querySelector(".epl-num");
                        var sub = a.querySelector(".epl-title");
                        var t = cleanText(num ? num.textContent : "");
                        var s = cleanText(sub ? sub.textContent : "");
                        var fullTitle = t + (s ? " - " + s : "");
                        
                        var id = a.getAttribute("href").split('/').filter(Boolean).pop();
                        chaps.push({ title: fullTitle, id: id });
                    }
                    // Central geralmente lista do mais novo pro antigo, invertemos para leitura
                    cb({ title: title, desc: "CentralNovel", chapters: chaps.reverse() });
                });
            },
            read: function(slug, cb) {
                httpRequest("https://centralnovel.com/" + slug + "/", "GET", null, function(err, html) {
                    if(err) return cb(null);
                    var doc = parseHTML(html);
                    cb({
                        title: cleanText(doc.querySelector("h1").textContent),
                        content: doc.querySelector(".epcontent").innerHTML
                    });
                });
            }
        },

        // --- ILLUSIA ---
        illusia: {
            search: function(q, cb) {
                httpRequest("https://illusia.com.br/?s=" + encodeURIComponent(q) + "&post_type=fcn_story", "POST", null, function(err, html) {
                    if(err) return cb([]);
                    var doc = parseHTML(html);
                    var items = doc.querySelectorAll("li.card a");
                    var list = [];
                    for(var i=0; i<items.length; i++) {
                        var slug = items[i].getAttribute("href").split('/').filter(Boolean).pop();
                        list.push({ source: 'illusia', id: 'illusia-' + slug, title: cleanText(items[i].textContent) });
                    }
                    cb(list);
                });
            },
            info: function(slug, cb) {
                httpRequest("https://illusia.com.br/story/" + slug + "/", "GET", null, function(err, html) {
                    if(err) return cb(null);
                    var doc = parseHTML(html);
                    var title = cleanText(doc.querySelector(".story__identity-title").textContent);
                    var links = doc.querySelectorAll(".chapter-group__list a");
                    var chaps = [];
                    for(var i=0; i<links.length; i++) {
                        var id = links[i].getAttribute("href").split('/').filter(Boolean).pop();
                        chaps.push({ title: cleanText(links[i].textContent), id: id });
                    }
                    cb({ title: title, desc: "Illusia", chapters: chaps });
                });
            },
            read: function(novelSlug, chapSlug, cb) {
                httpRequest("https://illusia.com.br/story/" + novelSlug + "/" + chapSlug + "/", "GET", null, function(err, html) {
                    if(err) return cb(null);
                    var doc = parseHTML(html);
                    cb({
                        title: cleanText(doc.querySelector(".chapter__title").textContent),
                        content: doc.querySelector("#chapter-content").innerHTML
                    });
                });
            }
        },

        // --- NOVEL MANIA ---
        mania: {
            search: function(q, cb) {
                httpRequest("https://novelmania.com.br/novels?titulo=" + encodeURIComponent(q), "GET", null, function(err, html) {
                    if(err) return cb([]);
                    var doc = parseHTML(html);
                    var items = doc.querySelectorAll(".top-novels"); // Pode variar
                    var list = [];
                    for(var i=0; i<items.length; i++) {
                        var h5 = items[i].querySelector("h5");
                        var a = items[i].querySelector("a");
                        if(h5 && a) {
                            var slug = a.getAttribute("href").split('/').filter(Boolean).pop();
                            list.push({ source: 'mania', id: 'mania-' + slug, title: cleanText(h5.textContent) });
                        }
                    }
                    cb(list);
                });
            },
            info: function(slug, cb) {
                httpRequest("https://novelmania.com.br/novels/" + slug + "/", "GET", null, function(err, html) {
                    if(err) return cb(null);
                    var doc = parseHTML(html);
                    var title = cleanText(doc.querySelector("h1").textContent);
                    var links = doc.querySelectorAll("ol.list-inline li a");
                    var chaps = [];
                    for(var i=0; i<links.length; i++) {
                        var id = links[i].getAttribute("href").split('/').filter(Boolean).pop();
                        var strong = links[i].querySelector("strong");
                        chaps.push({ title: cleanText(strong ? strong.textContent : "Cap√≠tulo"), id: id });
                    }
                    cb({ title: title, desc: "NovelMania", chapters: chaps });
                });
            },
            read: function(novelSlug, chapSlug, cb) {
                httpRequest("https://novelmania.com.br/novels/" + novelSlug + "/capitulos/" + chapSlug, "GET", null, function(err, html) {
                    if(err) return cb(null);
                    var doc = parseHTML(html);
                    cb({
                        title: cleanText(doc.querySelector("h2").textContent),
                        content: doc.querySelector("#chapter-content").innerHTML
                    });
                });
            }
        }
    };

    // =========================================================
    // 3. APP CONTROLLER
    // =========================================================
    var App = {
        history: [],
        currNovel: null,
        currChap: null,

        init: function() {
            try {
                var h = localStorage.getItem('kindle_hist_v3');
                if(h) this.history = JSON.parse(h);
            } catch(e) {}
            this.goHome();
        },

        loading: function(show, msg) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
            document.getElementById('status-msg').innerText = msg || "";
        },

        show: function(id) {
            var vs = ['view-list', 'view-details', 'view-reader'];
            for(var i=0; i<vs.length; i++) document.getElementById(vs[i]).style.display = 'none';
            document.getElementById(id).style.display = 'block';
            window.scrollTo(0,0);
        },

        goHome: function() {
            this.show('view-list');
            document.getElementById('list-header').innerText = "Hist√≥rico de Leitura";
            document.getElementById('search-input').value = "";
            
            var c = document.getElementById('list-content');
            if(this.history.length === 0) { c.innerHTML = "<p>Nada no hist√≥rico.</p>"; return; }
            
            var html = "";
            for(var i=0; i<this.history.length; i++) {
                var h = this.history[i];
                html += '<div class="list-item">';
                html += '<span class="badge bg-' + h.source + '">' + h.source + '</span>';
                html += '<span class="list-title">' + h.name + '</span>';
                html += '<div style="color:#666; font-size:0.9em; margin:5px 0">Parou em: ' + h.chapName + '</div>';
                html += '<button onclick="App.loadNovel(\'' + h.id + '\')">VER CAP√çTULOS</button>';
                html += '<button style="border-style:dashed" onclick="App.read(\'' + h.chapId + '\')">CONTINUAR</button>';
                html += '</div>';
            }
            c.innerHTML = html;
        },

        search: function() {
            var q = document.getElementById('search-input').value;
            if(!q) return;
            this.show('view-list');
            document.getElementById('list-header').innerText = "Buscando: " + q;
            document.getElementById('list-content').innerHTML = "";
            
            this.loading(true, "Pesquisando nas 3 fontes...");
            
            var results = [];
            var pending = 3;
            var done = function() {
                pending--;
                if(pending <= 0) {
                    App.loading(false);
                    if(results.length === 0) {
                        document.getElementById('list-content').innerHTML = "<p>Nenhum resultado encontrado.</p>";
                        return;
                    }
                    var html = "";
                    for(var i=0; i<results.length; i++) {
                        var r = results[i];
                        html += '<div class="list-item">';
                        html += '<span class="badge bg-' + r.source + '">' + r.source + '</span>';
                        html += '<span class="list-title">' + r.title + '</span>';
                        html += '<button style="margin-top:5px" onclick="App.loadNovel(\'' + r.id + '\')">ABRIR</button>';
                        html += '</div>';
                    }
                    document.getElementById('list-content').innerHTML = html;
                }
            };

            // Dispara as 3 buscas
            Scraper.central.search(q, function(res) { results = results.concat(res); done(); });
            Scraper.illusia.search(q, function(res) { results = results.concat(res); done(); });
            Scraper.mania.search(q, function(res) { results = results.concat(res); done(); });
        },

        loadNovel: function(id) {
            var parts = id.split('-');
            var source = parts[0];
            var slug = parts.slice(1).join('-');
            
            this.loading(true, "Carregando cap√≠tulos...");
            this.show('view-details');
            document.getElementById('det-title').innerText = "Carregando...";
            document.getElementById('det-chapters').innerHTML = "";

            var cb = function(info) {
                App.loading(false);
                if(!info) { alert("Erro ao carregar obra"); App.goHome(); return; }
                
                App.currNovel = { id: id, source: source, slug: slug, info: info };
                document.getElementById('det-title').innerText = info.title;
                document.getElementById('det-desc').innerText = "Fonte: " + info.desc;
                
                var html = "";
                for(var i=0; i<info.chapters.length; i++) {
                    var c = info.chapters[i];
                    html += '<button style="text-align:left; font-weight:normal" onclick="App.read(\'' + c.id + '\')">' + c.title + '</button>';
                }
                document.getElementById('det-chapters').innerHTML = html;
            };

            if(source === 'central') Scraper.central.info(slug, cb);
            else if(source === 'illusia') Scraper.illusia.info(slug, cb);
            else if(source === 'mania') Scraper.mania.info(slug, cb);
        },

        read: function(chapId) {
            if(!this.currNovel) return;
            this.currChap = chapId;
            this.show('view-reader');
            this.loading(true, "Carregando texto...");
            document.getElementById('reader-content').innerHTML = "";
            document.getElementById('chap-title').innerText = "Carregando...";
            
            var cb = function(data) {
                App.loading(false);
                if(!data) { document.getElementById('reader-content').innerHTML = "Erro ao carregar."; return; }
                
                // Limpeza de scripts
                var temp = parseHTML(data.content);
                var scripts = temp.getElementsByTagName('script');
                while(scripts[0]) scripts[0].parentNode.removeChild(scripts[0]);

                document.getElementById('chap-title').innerText = data.title;
                document.getElementById('reader-content').innerHTML = temp.innerHTML;
                
                // Salvar Hist√≥rico
                App.saveHistory(data.title);
                
                window.scrollTo(0,0);
            };

            var s = this.currNovel.source;
            var ns = this.currNovel.slug;
            
            if(s === 'central') Scraper.central.read(chapId, cb);
            else if(s === 'illusia') Scraper.illusia.read(ns, chapId, cb);
            else if(s === 'mania') Scraper.mania.read(ns, chapId, cb);
        },

        backToDetails: function() {
            this.show('view-details');
        },

        saveHistory: function(chapName) {
            var nid = this.currNovel.id;
            var temp = [];
            for(var i=0; i<this.history.length; i++) {
                if(this.history[i].id !== nid) temp.push(this.history[i]);
            }
            temp.unshift({
                id: nid,
                name: this.currNovel.info.title,
                source: this.currNovel.source,
                chapName: chapName,
                chapId: this.currChap
            });
            if(temp.length > 10) temp.pop();
            this.history = temp;
            localStorage.setItem('kindle_hist_v3', JSON.stringify(this.history));
        },

        // Navega√ß√£o simples baseada em √≠ndice do array
        nextChap: function() { this.moveChap(1); },
        prevChap: function() { this.moveChap(-1); },
        
        moveChap: function(dir) {
            var chaps = this.currNovel.info.chapters;
            var idx = -1;
            for(var i=0; i<chaps.length; i++) {
                if(chaps[i].id === this.currChap) { idx = i; break; }
            }
            if(idx === -1) return;
            
            var newIdx = idx + dir;
            if(newIdx >= 0 && newIdx < chaps.length) {
                this.read(chaps[newIdx].id);
            } else {
                alert("Fim da lista carregada.");
            }
        }
    };

    window.onload = function() { App.init(); };
</script>
</body>
</html>
